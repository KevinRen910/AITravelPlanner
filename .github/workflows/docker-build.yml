name: Docker Build and Push to ACR

on:
  push:
    branches: [ main ]  # 当推送到main分支时触发
  pull_request:
    branches: [ main ]  # 当有PR合并到main分支时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - name: Check out the code
        uses: actions/checkout@v4

      # 2. 设置Docker Buildx（支持多平台构建）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 登录到阿里云容器镜像服务（如果不需要推送，可以注释掉）
      - name: Log in to Alibaba Cloud Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_ACR_REGISTRY }}
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}

      # 4. 先尝试只构建后端（确认后端是否能正常构建）
      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          tags: |
            ${{ secrets.ALIYUN_ACR_REGISTRY }}/ai_travel_planner_backend:latest
          push: true

      # 5. 修改前端Dockerfile以增加调试信息
      - name: Update frontend Dockerfile for debugging
        run: |
          echo "# 构建阶段
          FROM node:18-alpine AS build
          
          WORKDIR /app
          
          # 安装额外的依赖用于调试
          RUN apk add --no-cache bash
          
          COPY package*.json ./
          # 增加安装依赖的详细日志
          RUN npm install --verbose
          
          COPY . .
          # 先运行TypeScript检查，查看具体错误
          RUN echo "Running TypeScript check..."
          RUN npx tsc --noEmit || echo "TypeScript check failed, continuing..."
          # 增加构建详细日志
          RUN echo "Running Vite build..."
          RUN npm run build --verbose
          " > frontend/Dockerfile.tmp
          mv frontend/Dockerfile.tmp frontend/Dockerfile

      # 6. 构建前端镜像（先不推送，仅验证构建）
      - name: Build frontend image (debug mode)
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          tags: |
            ${{ secrets.ALIYUN_ACR_REGISTRY }}/ai_travel_planner_frontend:latest
          push: false  # 先不推送，成功后再修改为true
          build-args: |
            # 可选：添加构建参数
            NODE_ENV=production